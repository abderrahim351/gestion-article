<div class="mt-6">
  <h3 class="text-lg font-semibold mb-3">Commentaires</h3>

  <div *ngIf="auth.isLoggedIn(); else mustLogin" class="mb-4">
    <form [formGroup]="form" (ngSubmit)="submitRootComment()" class="space-y-2">
      <textarea
        rows="3"
        formControlName="content"
        placeholder="Ajouter un commentaire..."
        class="w-full border rounded px-3 py-2 text-sm"
      ></textarea>
      <button
        type="submit"
        [disabled]="form.invalid"
        class="px-3 py-1 text-xs rounded bg-blue-600 text-white hover:bg-blue-500"
      >
        Commenter
      </button>
    </form>
  </div>

  <ng-template #mustLogin>
    <p class="text-xs text-gray-600 mb-3">
      Connectez-vous pour commenter.
    </p>
  </ng-template>

  <div *ngIf="loading" class="text-sm text-gray-500">
    Chargement des commentaires...
  </div>

  <div *ngIf="!loading && comments.length === 0" class="text-xs text-gray-500">
    Aucun commentaire pour le moment.
  </div>

  <div class="space-y-3" *ngIf="!loading && comments.length > 0">
    <ng-container *ngFor="let comment of comments">
      <div class="bg-white border rounded p-3">
        <p class="text-xs text-gray-500 mb-1">
          {{ comment.author?.name }} • {{ comment.createdAt | date: 'short' }}
        </p>
        <p class="text-sm text-gray-800 whitespace-pre-line">
          {{ comment.content }}
        </p>
        <div class="mt-2">
          <button
            *ngIf="auth.isLoggedIn()"
            (click)="startReply(comment.id)"
            class="text-xs text-blue-600 hover:underline"
          >
            Répondre
          </button>
        </div>

        <div *ngIf="replyingTo === comment.id" class="mt-2">
          <textarea
            rows="2"
            [(ngModel)]="replyForms[comment.id]"
            class="w-full border rounded px-2 py-1 text-xs"
            placeholder="Votre réponse..."
          ></textarea>
          <div class="mt-1 flex gap-2">
            <button
              (click)="submitReply(comment.id)"
              class="px-2 py-1 text-xs rounded bg-blue-600 text-white"
            >
              Envoyer
            </button>
            <button
              (click)="cancelReply()"
              class="px-2 py-1 text-xs rounded border"
            >
              Annuler
            </button>
          </div>
        </div>

     
        <div class="mt-3 pl-4 border-l space-y-2" *ngIf="comment.replies?.length">
          <ng-container *ngFor="let reply of comment.replies">
            <div class="bg-gray-50 border rounded p-2">
              <p class="text-xs text-gray-500 mb-1">
                {{ reply.author?.name }} • {{ reply.createdAt | date: 'short' }}
              </p>
              <p class="text-xs text-gray-800 whitespace-pre-line">
                {{ reply.content }}
              </p>
            </div>
          </ng-container>
        </div>
      </div>
    </ng-container>
  </div>
</div>
